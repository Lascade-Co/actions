name: Publish Play Store

on:
  repository_dispatch:
    types: [publish-playstore]

permissions:
  contents: read

concurrency:
  group: playstore-${{ github.event.client_payload.package_name }}
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      TRACK: production
      TARGET_COUNTRY: BD
      TARGET_FRACTION: "0.99"

    steps:
      - name: Checkout central repo (for scripts)
        uses: actions/checkout@v4

      - name: Validate payload
        shell: bash
        run: |
          set -euo pipefail
          : "${{ github.event.client_payload.repo }}"
          : "${{ github.event.client_payload.release_id }}"
          : "${{ github.event.client_payload.package_name }}"
          : "${{ github.event.client_payload.app_name }}"
          : "${{ github.event.client_payload.play_console_production_url }}"

      - name: Parse owner/repo
        id: repo
        shell: bash
        run: |
          set -euo pipefail
          FULL="${{ github.event.client_payload.repo }}"
          echo "owner=${FULL%%/*}" >> "$GITHUB_OUTPUT"
          echo "name=${FULL#*/}"   >> "$GITHUB_OUTPUT"

      - name: Mint GitHub App token (target repo)
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CI_APP_ID }}
          private-key: ${{ secrets.CI_APP_PRIVATE_KEY }}
          owner: ${{ steps.repo.outputs.owner }}
          repositories: ${{ steps.repo.outputs.name }}

      - name: Fetch GitHub Release + write Play whatsnew (single locale)
        id: meta
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const owner = '${{ steps.repo.outputs.owner }}';
            const repo  = '${{ steps.repo.outputs.name }}';
            const releaseId = Number('${{ github.event.client_payload.release_id }}');
            const locale = ('${{ github.event.client_payload.release_notes_locale || 'en-US' }}').trim();

            const sleep = ms => new Promise(r => setTimeout(r, ms));
            let rel;

            for (let i = 0; i < 5; i++) {
              rel = await github.rest.repos.getRelease({ owner, repo, release_id: releaseId });
              const assets = rel.data.assets || [];
              const hasAab = assets.some(a => a.name.toLowerCase().endsWith('.aab'));
              const hasSym = assets.some(a => /native-debug-symbols.*\.zip$/i.test(a.name));
              if (hasAab && hasSym) break;
              await sleep(2000);
            }

            const tag = rel.data.tag_name || '';
            const ghUrl = rel.data.html_url;
            const rawNotes = (rel.data.body || '').trim();

            const truncate = (s, max) => {
              const a = Array.from(s);
              return a.length <= max ? s : a.slice(0, max - 1).join('') + '…';
            };

            // Play "What's new": 500 Unicode chars per locale
            const playNotes = truncate(rawNotes || `See GitHub release: ${ghUrl}`, 500);

            const whatsNewDir = path.join(process.env.GITHUB_WORKSPACE, 'whatsnew');
            fs.mkdirSync(whatsNewDir, { recursive: true });
            fs.writeFileSync(path.join(whatsNewDir, `whatsnew-${locale}`), playNotes, 'utf8');

            // Raw notes for Telegram (truncate later in python)
            fs.writeFileSync('release_notes_raw.txt', rawNotes, 'utf8');

            core.setOutput('tag', tag);
            core.setOutput('gh_url', ghUrl);
            core.setOutput('locale', locale);

      - name: Download release assets
        uses: robinraju/release-downloader@v1
        with:
          repository: ${{ github.event.client_payload.repo }}
          releaseId: ${{ github.event.client_payload.release_id }}
          fileName: "*"
          out-file-path: release-assets
          token: ${{ steps.app-token.outputs.token }}

      - name: Locate AAB + native debug symbols
        id: assets
        shell: bash
        run: |
          set -euo pipefail
          ls -lah release-assets
          AAB=$(find release-assets -maxdepth 1 -name "*.aab" | head -n 1)
          SYM=$(find release-assets -maxdepth 1 -iname "*native-debug-symbols*.zip" | head -n 1)
          : "${AAB:?Missing AAB}"
          : "${SYM:?Missing native debug symbols zip}"
          echo "aab=$AAB" >> "$GITHUB_OUTPUT"
          echo "symbols=$SYM" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Publish rollout + write Telegram message (python)
        env:
          SA_B64: ${{ secrets.SUBSCRIPTION_PLAY_SERVICE_ACCOUNT_JSON_BASE64 }}
        run: |
          set -euo pipefail
          echo "$SA_B64" | base64 --decode > play-sa.json

          python3 scripts/publish_playstore.py \
            --service-account-json play-sa.json \
            --package-name "${{ github.event.client_payload.package_name }}" \
            --track "${{ env.TRACK }}" \
            --aab "${{ steps.assets.outputs.aab }}" \
            --native-symbols "${{ steps.assets.outputs.symbols }}" \
            --release-name "${{ steps.meta.outputs.tag }}" \
            --notes-file "whatsnew/whatsnew-${{ steps.meta.outputs.locale }}" \
            --raw-notes-file "release_notes_raw.txt" \
            --app-name "${{ github.event.client_payload.app_name }}" \
            --github-release-url "${{ steps.meta.outputs.gh_url }}" \
            --play-console-production-url "${{ github.event.client_payload.play_console_production_url }}" \
            --country "${{ env.TARGET_COUNTRY }}" \
            --user-fraction "${{ env.TARGET_FRACTION }}" \
            --telegram-out "github_release_body.txt"

      - name: Notify Telegram (success)
        uses: appleboy/telegram-action@v1.0.1
        with:
          token: ${{ secrets.SUBSCRIPTION_TELEGRAM_TOKEN }}
          to: ${{ secrets.SUBSCRIPTION_TELEGRAM_TO }}
          format: html
          message_file: github_release_body.txt
          disable_web_page_preview: true

      - name: Notify Telegram (FAILURE)
        if: failure()
        continue-on-error: true
        uses: appleboy/telegram-action@v1.0.1
        with:
          token: ${{ secrets.SUBSCRIPTION_TELEGRAM_TOKEN }}
          to: ${{ secrets.SUBSCRIPTION_TELEGRAM_TO }}
          format: html
          disable_web_page_preview: true
          message: |
            <b>❌ Play Store publish failed</b>

            <b>App:</b> ${{ github.event.client_payload.app_name }}
            <b>Package:</b> <code>${{ github.event.client_payload.package_name }}</code>
            <b>Repo:</b> <code>${{ github.event.client_payload.repo }}</code>
            <b>Release ID:</b> <code>${{ github.event.client_payload.release_id }}</code>

            <b>Run:</b>
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
