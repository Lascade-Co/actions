name: Central Publish SPM

on:
  repository_dispatch:
    types: [publish-spm]

concurrency:
  group: publish-spm-${{ github.event.client_payload.repo }}
  cancel-in-progress: true

jobs:
  get-base-token:
    runs-on: ubuntu-latest
    outputs:
      token: ${{ steps.app-token.outputs.token }}
    steps:
      - name: Extract owner/repo
        id: repo
        shell: bash
        run: |
          FULL="${{ github.event.client_payload.repo }}"
          echo "owner=${FULL%%/*}" >> "$GITHUB_OUTPUT"
          echo "name=${FULL#*/}" >> "$GITHUB_OUTPUT"

      - name: Mint GitHub App token (source repo)
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CI_APP_ID }}
          private-key: ${{ secrets.CI_APP_PRIVATE_KEY }}
          owner: ${{ steps.repo.outputs.owner }}
          repositories: ${{ steps.repo.outputs.name }}

  get-spm-token:
    runs-on: ubuntu-latest
    outputs:
      token: ${{ steps.spm-token.outputs.token }}
    steps:
      - name: Extract SPM owner/repo
        id: spm_repo
        shell: bash
        run: |
          FULL="${{ github.event.client_payload.spm_repo }}"
          echo "owner=${FULL%%/*}" >> "$GITHUB_OUTPUT"
          echo "name=${FULL#*/}" >> "$GITHUB_OUTPUT"

      - name: Mint GitHub App token (SPM repo)
        id: spm-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CI_APP_ID }}
          private-key: ${{ secrets.CI_APP_PRIVATE_KEY }}
          owner: ${{ steps.spm_repo.outputs.owner }}
          repositories: ${{ steps.spm_repo.outputs.name }}

  publish:
    runs-on: macos-latest
    needs: [get-base-token, get-spm-token]
    steps:
      - name: Decide ref to checkout
        id: ref
        run: |
          BR="${{ github.event.client_payload.branch }}"
          if [ -n "$BR" ]; then
            echo "ref=refs/heads/${BR}" >> $GITHUB_OUTPUT
          else
            echo "No branch in payload" >&2
            exit 1
          fi

      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.repo }}
          ref: ${{ steps.ref.outputs.ref }}
          token: ${{ needs.get-base-token.outputs.token }}
          fetch-depth: 1

      - name: Fetch local.properties from Infisical
        uses: Infisical/secrets-action@v1.0.9
        with:
          method: universal
          client-id: ${{ secrets.INFISICAL_CLIENT_ID }}
          client-secret: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          project-slug: ${{ github.event.client_payload.project_slug }}
          env-slug: "production"
          domain: ${{ secrets.INFISICAL_DOMAIN }}
          secret-path: /Local-Properties
          export-type: file
          file-output-path: /local.properties

      - name: Clean local.properties
        run: sed -i -e "s/'//g" local.properties

      - name: Cache Kotlin/Native
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: konan-${{ runner.os }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}-${{ hashFiles('**/gradle/libs.versions.toml') }}
          restore-keys: |
            konan-${{ runner.os }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}-
            konan-${{ runner.os }}-

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Increment version
        id: version
        run: bash ./increment_version.sh

      - name: Build XCFramework
        run: ./gradlew :shared:assembleSharedReleaseXCFramework

      - name: Checkout SPM repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.spm_repo }}
          token: ${{ needs.get-spm-token.outputs.token }}
          path: spm-repo
          fetch-depth: 1

      - name: Remove existing XCFramework
        run: rm -rf spm-repo/TAShared.xcframework

      - name: Copy XCFramework to SPM repo
        run: cp -r shared/build/XCFrameworks/release/shared.xcframework spm-repo/TAShared.xcframework

      - name: Commit XCFramework
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          repository: spm-repo
          file_pattern: spm-repo/TAShared.xcframework/**/*
          tag_name: v${{ steps.version.outputs.new_version }}
          commit_message: Update to v${{ steps.version.outputs.new_version }}
          branch: main
