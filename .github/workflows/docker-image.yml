name: "Docker Build and Push"

on:
  repository_dispatch:
    types: [docker-build]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: docker-build-${{ github.event.client_payload.repo }}-${{ github.event.client_payload.pr || github.event.client_payload.branch }}
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      owner: ${{ steps.repo.outputs.owner }}
      name: ${{ steps.repo.outputs.name }}
      branch: ${{ steps.branch.outputs.branch }}
    steps:
      - name: Extract owner/repo
        id: repo
        run: |
          FULL="${{ github.event.client_payload.repo }}"
          echo "owner=${FULL%%/*}" >> "$GITHUB_OUTPUT"
          echo "name=${FULL#*/}"   >> "$GITHUB_OUTPUT"

      - name: Resolve branch
        id: branch
        run: |
          BR="${{ github.event.client_payload.branch }}"
          echo "branch=${BR:-main}" >> "$GITHUB_OUTPUT"

  build-and-push:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Mint GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CI_APP_ID }}
          private-key: ${{ secrets.CI_APP_PRIVATE_KEY }}
          owner: ${{ needs.prepare.outputs.owner }}
          repositories: ${{ needs.prepare.outputs.name }}

      - name: Purge previous comments from this workflow
        if: github.event.client_payload.pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const [owner, repo] = "${{ github.event.client_payload.repo }}".split("/");
            const issue_number = Number("${{ github.event.client_payload.pr }}");
            const marker = "<!-- central-docker-build -->";
            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number, per_page: 100 }
            );
            let deleted = 0;
            for (const c of comments) {
              if ((c.body || "").includes(marker)) {
                await github.rest.issues.deleteComment({ owner, repo, comment_id: c.id });
                deleted++;
              }
            }
            core.info(`Deleted ${deleted} prior central-docker-build comments`);

      - name: Comment on PR About Action Status
        if: github.event.client_payload.pr
        uses: peter-evans/create-or-update-comment@v4
        id: status
        with:
          edit-mode: 'replace'
          token: ${{ steps.app-token.outputs.token }}
          repository: ${{ github.event.client_payload.repo }}
          issue-number: ${{ github.event.client_payload.pr }}
          body: |
            <!-- central-docker-build -->
            üèóÔ∏è Docker build started.
            Watch progress [here](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Checkout target repo @ branch
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.repo }}
          ref: refs/heads/${{ needs.prepare.outputs.branch }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0
          submodules: "recursive"

      - name: Get commit SHA
        id: commit
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          load: true
          context: '.'
          file: 'Dockerfile'
          tags: |
            ${{ secrets.REGISTRY }}/${{ github.event.client_payload.container_name }}:${{ steps.commit.outputs.sha }}
            ${{ secrets.REGISTRY }}/${{ github.event.client_payload.container_name }}:latest

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 600

      - name: Push image to DigitalOcean Container Registry
        run: |
          docker push ${{ secrets.REGISTRY }}/${{ github.event.client_payload.container_name }}:${{ steps.commit.outputs.sha }}
          docker push ${{ secrets.REGISTRY }}/${{ github.event.client_payload.container_name }}:latest

      - name: Comment on PR with success
        if: ${{ success() && github.event.client_payload.pr }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: ${{ github.event.client_payload.repo }}
          issue-number: ${{ github.event.client_payload.pr }}
          comment-id: ${{ steps.status.outputs.comment-id }}
          edit-mode: 'replace'
          body: |
            <!-- central-docker-build -->
            ‚úÖ Docker image built and pushed successfully.
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Comment on PR if build failed
        if: ${{ failure() && github.event.client_payload.pr }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.status.outputs.comment-id }}
          token: ${{ steps.app-token.outputs.token }}
          repository: ${{ github.event.client_payload.repo }}
          issue-number: ${{ github.event.client_payload.pr }}
          edit-mode: 'replace'
          body: |
            <!-- central-docker-build -->
            ‚ùå Build failed.
            [Check logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
